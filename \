var jsonfile = require('jsonfile');
var fs = require('fs');
var mongoose = require('mongoose');
var xml = require('xml-js');
let csvToJson = require('convert-csv-to-json');


var print = (string) => console.log(string);
var Info = (string) => console.info(string);
var last = (a) => a[a.length - 1];
var head = (a) => a[0];

var is_format_x = (string) => (format_x) => last (string.split(".")) == format_x
var is_json = (string) => is_format_x (string) ("json")
var is_xml = (string) => is_format_x (string) ("xml")
var is_csv = (string) => is_format_x (string) ("csv")



// TODO: create_dataBase
var create_dataBase = (name) => mongoose.connect("mongodb://127.0.0.1/" + name)
// TODO: schema
var schema = () => new mongoose.Schema({});
// TODO: create_collection
var create_collection = (name) => mongoose.model(name,schema());

// TODO: is_Array
var is_Array = (content) => Array.is_Array(content);
var insert_all = (list) =>(nameDB) => (nameC) => nameDB.nameC.insertMany(list);
var insert = (element) =>(nameDB) => (nameC) => nameDB.nameC.insert(element);



// TODO: mongoimport
var mongoimport = (nameBD,nameC,content) => {
                                    create_dataBase (nameDB);
                                    create_collection (nameC);
                                    (is_Array (content))? insert_all (content) (nameDB) (nameC)
                                              : insert (content) (nameDB) (nameC);
                                    }

var readFile = (filename) => fs.readFileSync(filename).toString();
var xml_to_json = (filename) => xml.xml2json(readFile(filename), {compact: true, spaces: 4});
var csv_to_json = (filename) => csvToJson.getJsonFromCsv(filename)

// TODO: jsonFile_to_mongo
var jsonFile_to_mongo = (filename) => mongoimport( readFile(filename) );
// TODO: xmlFile_to_mongo
var csvFile_to_mongo = (filename) => mongoimport( xml_to_json (filename) );
// TODO: xmlFile_to_mongo
var csvFile_to_mongo = (filename) => mongoimport( csv_to_json (filename) );

var myArgs = process.argv.slice(2);
// node mongoimport.js <filename (json or xml or csv)> <databse name> <collection name> FLAGS
// FLAGS --xslt=<name.xsl>

file = myArgs[0]
db_name = myArgs[1]
c_name = myArgs[2]
flags = myArgs[3]

print(myArgs);
print(file)


if(is_json (file)){
    jsonFile_to_mongo(file);
}else
    if(is_xml){
        //xmlFile_to_mongo(file);
    }else{
        print("O programa ainda n√£o esta preparado para processar este tipo de dados") 
    }

content_file = fs.readFileSync(file).toString();
print(content_file);
print(is_json(file))
print(last(file.split(".")))
var xml_content =
'<?xml version="1.0" encoding="utf-8"?>' +
'<note importance="high" logged="true">' +
'    <title>Happy</title>' +
'    <todo>Work</todo>' +
'    <todo>Play</todo>' +
'</note>';
print(xml_to_json(xml_content))
//var result1 = xml.xml2json(xml_content, {compact: true, spaces: 4});
//var result2 = xml.xml2json(xml_content, {compact: false, spaces: 4});
//console.log(result1, '\n', result2);

print(csvToJson.getJsonFromCsv(file));
